<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing a Simple FSM (Python) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                        <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="../cpp/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../cpp/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../cpp/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../cpp/service_client_demo.html">Service Client</a></li>
                <li><a href="../cpp/action_client_demo.html">Action Client</a></li>
                <li><a href="../cpp/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../cpp/publisher_demo.html">Publisher</a></li>
                <li><a href="../cpp/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../cpp/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../cpp/factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/yasmin_demos/yasmin_demo.py" target="_blank" style="color: inherit; text-decoration: none;">Writing a Simple FSM (Python)</a></h1>
            <p>This tutorial shows how to create a simple Finite State Machine (FSM) using YASMIN in Python. We will create two custom states, <code>FooState</code> and <code>BarState</code>, and transition between them. This example demonstrates the fundamental concepts of state machines: defining states with specific behaviors, managing state transitions, and sharing data between states using the blackboard. Python's syntax makes it easy to create readable and maintainable state machines.</p>

            <h2>1. Create the FooState</h2>
            <p>First, we define the <code>FooState</code> class inheriting from <code>yasmin.State</code>. This state will increment a counter and switch outcomes based on the counter value. The constructor initializes two possible outcomes: <code>"outcome1"</code> (to continue to BarState) and <code>"outcome2"</code> (to finish execution). In the <code>execute()</code> method, we check if the counter is less than 3 - if so, we increment it, store a message in the blackboard, and return <code>"outcome1"</code> to transition to BarState. After 3 executions, we return <code>"outcome2"</code> to end the state machine.</p>

            <pre><code class="language-python">class FooState(State):
    """
    Represents the Foo state in the state machine.

    Attributes:
        counter (int): Counter to track the number of executions of this state.
    """

    def __init__(self) -> None:
        """
        Initializes the FooState instance, setting up the outcomes.

        Outcomes:
            outcome1: Indicates the state should continue to the Bar state.
            outcome2: Indicates the state should finish execution and return.
        """
        super().__init__(["outcome1", "outcome2"])
        self.counter = 0

    def execute(self, blackboard: Blackboard) -> str:
        """
        Executes the logic for the Foo state.

        Args:
            blackboard (Blackboard): The shared data structure for states.

        Returns:
            str: The outcome of the execution, which can be "outcome1" or "outcome2".

        Raises:
            Exception: May raise exceptions related to state execution.
        """
        yasmin.YASMIN_LOG_INFO("Executing state FOO")
        time.sleep(3)

        if self.counter < 3:
            self.counter += 1
            blackboard["foo_str"] = f"Counter: {self.counter}"
            return "outcome1"
        else:
            return "outcome2"</code></pre>

            <h2>2. Create the BarState</h2>
            <p>Next, we define the <code>BarState</code>, which serves as an intermediary state in our FSM. This state has only one possible outcome: <code>"outcome3"</code>, which will transition back to FooState, creating a loop. In the <code>execute()</code> method, we retrieve the string that FooState stored in the blackboard (using dictionary-style access with <code>blackboard["foo_str"]</code>) and log it using YASMIN's logging system. This demonstrates inter-state communication through the blackboard - a shared data structure that allows states to pass information to each other. The <code>time.sleep(3)</code> call simulates processing time.</p>

            <pre><code class="language-python">class BarState(State):
    """
    Represents the Bar state in the state machine.
    """

    def __init__(self) -> None:
        """
        Initializes the BarState instance, setting up the outcome.

        Outcomes:
            outcome3: Indicates the state should transition back to the Foo state.
        """
        super().__init__(outcomes=["outcome3"])

    def execute(self, blackboard: Blackboard) -> str:
        """
        Executes the logic for the Bar state.

        Args:
            blackboard (Blackboard): The shared data structure for states.

        Returns:
            str: The outcome of the execution, which will always be "outcome3".

        Raises:
            Exception: May raise exceptions related to state execution.
        """
        yasmin.YASMIN_LOG_INFO("Executing state BAR")
        time.sleep(3)

        yasmin.YASMIN_LOG_INFO(blackboard["foo_str"])
        return "outcome3"</code></pre>

            <h2>3. Main Function</h2>
            <p>In the main function, we initialize ROS 2 and construct the complete state machine. First, <code>rclpy.init()</code> initializes the ROS 2 Python client library, and <code>set_ros_loggers()</code> configures YASMIN to use ROS logging. We create a <code>StateMachine</code> with <code>"outcome4"</code> as the terminal outcome that ends execution. Using the <code>add_state()</code> method, we register both FooState and BarState, defining a dictionary of transitions for each: FooState can transition to BarState (<code>"outcome1"</code>) or terminate (<code>"outcome2"</code>), while BarState always loops back to FooState (<code>"outcome3"</code>). The <code>YasminViewerPub</code> publishes state machine data for real-time visualization in a web interface. Finally, we execute the state machine by calling <code>sm()</code>, handle keyboard interrupts gracefully, and shut down ROS 2.</p>

            <pre><code class="language-python">def main() -> None:
    yasmin.YASMIN_LOG_INFO("yasmin_demo")
    rclpy.init()
    set_ros_loggers()

    # Create a finite state machine (FSM)
    sm = StateMachine(outcomes=["outcome4"])

    # Add states to the FSM
    sm.add_state(
        "FOO",
        FooState(),
        transitions={
            "outcome1": "BAR",
            "outcome2": "outcome4",
        },
    )
    sm.add_state(
        "BAR",
        BarState(),
        transitions={
            "outcome3": "FOO",
        },
    )

    # Publish FSM information for visualization
    viewer = YasminViewerPub(sm, "YASMIN_DEMO")

    # Execute the FSM
    try:
        outcome = sm()
        yasmin.YASMIN_LOG_INFO(outcome)
    except KeyboardInterrupt:
        if sm.is_running():
            sm.cancel_state()
    finally:
        viewer.cleanup()
        del sm

        # Shutdown ROS 2 if it's running
        if rclpy.ok():
            rclpy.shutdown()


if __name__ == "__main__":
    main()</code></pre>

            <h2>4. Run the Demo</h2>
            <p>Execute the Python script to see the state machine transition between FOO and BAR states:</p>
            <pre><code>ros2 run yasmin_demos yasmin_demo.py</code></pre>

            <p align="center">
              <img src="../../demo.gif" width="65%" />
            </p>


    <div class="page-navigation">
        <a href="../cpp/concurrence_demo.html" class="nav-button prev">C++: Concurrence Demo</a>
        <a href="../python/remap_demo.html" class="nav-button next">Python: Remapping Demo</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>
