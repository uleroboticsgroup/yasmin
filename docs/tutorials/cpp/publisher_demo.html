<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher (C++) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="../python/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../python/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../python/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../python/service_client_demo.html">Service Client</a></li>
                <li><a href="../python/action_client_demo.html">Action Client</a></li>
                <li><a href="../python/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../python/publisher_demo.html">Publisher</a></li>
                <li><a href="../python/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../python/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../python/factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/src/publisher_demo.cpp" target="_blank" style="color: inherit; text-decoration: none;">Publisher Demo (C++)</a></h1>
            <p>This tutorial demonstrates how to publish ROS 2 messages from within a YASMIN state machine using the <code>PublisherState</code> in C++. This is useful for sending commands to actuators, broadcasting status updates, or generating test data. Publishing states integrate with other state machine logic, allowing you to coordinate complex behaviors that involve both sensing (subscribing) and acting (publishing).</p>

            <h2>Background</h2>
            <p>The <code>PublisherState</code> allows states to:</p>
            <ul>
                <li>Publish messages to ROS 2 topics as part of state execution</li>
                <li>Generate message content dynamically from the blackboard</li>
                <li>Send periodic updates or commands as part of a control loop</li>
                <li>Coordinate publishing with other state machine operations</li>
                <li>Maintain state across multiple publish operations</li>
            </ul>

            <h2>1. Define the Publisher State</h2>
            <p>Create a class inheriting from <code>yasmin_ros::PublisherState</code>, templated with the message type <code>std_msgs::msg::Int32</code>. The constructor requires two parameters: the topic name (<code>"count"</code>) and a callback function that creates the message to publish. The <code>create_int_msg</code> method is invoked each time the state executes. It retrieves the current counter from the blackboard, increments it, stores the updated value back in the blackboard, and creates an Int32 message with the new counter value. This demonstrates stateful publishing - the counter persists across state executions thanks to the blackboard, allowing you to track progress or maintain sequences.</p>

            <pre><code class="language-cpp">class PublishIntState
    : public yasmin_ros::PublisherState&lt;std_msgs::msg::Int32&gt; {

public:
  PublishIntState()
      : yasmin_ros::PublisherState&lt;std_msgs::msg::Int32&gt;(
            "count", // topic name
            std::bind(&PublishIntState::create_int_msg, this,
                      _1) // create msg handler callback
        ) {};

  std_msgs::msg::Int32
  create_int_msg(std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard) {

    int counter = blackboard-&gt;get&lt;int&gt;("counter");
    counter++;
    blackboard-&gt;set&lt;int&gt;("counter", counter);

    YASMIN_LOG_INFO("Creating message %d", counter);
    std_msgs::msg::Int32 msg;
    msg.data = counter;
    return msg;
  };
};</code></pre>

            <h2>2. Create the State Machine</h2>
            <p>First, we define a <code>check_count</code> callback function that compares the current counter against a maximum value stored in the blackboard. This function introduces a small delay (1 second) to simulate processing time, then returns <code>"outcome1"</code> if the maximum is reached (to exit), or <code>"outcome2"</code> to continue publishing. In the main function, we create a state machine with two states: <code>PUBLISHING_INT</code> publishes a message and transitions to <code>CHECKINNG_COUNTS</code>, which evaluates the condition. If the maximum hasn't been reached, it loops back to <code>PUBLISHING_INT</code>, creating a publish-check cycle. We initialize the blackboard with <code>counter = 0</code> and <code>max_count = 10</code>, so the machine will publish 10 messages before completing. This pattern is useful for sending sequences of commands, periodic status updates, or controlled test data generation.</p>
            <pre><code class="language-cpp">std::string
check_count(std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard) {

  rclcpp::sleep_for(std::chrono::seconds(1));
  YASMIN_LOG_INFO("Checking count: %d", blackboard-&gt;get&lt;int&gt;("counter"));

  if (blackboard-&gt;get&lt;int&gt;("counter") &gt;= blackboard-&gt;get&lt;int&gt;("max_count")) {
    return "outcome1";
  } else {
    return "outcome2";
  }
}

int main(int argc, char *argv[]) {

  YASMIN_LOG_INFO("yasmin_publisher_demo");
  rclcpp::init(argc, argv);
  yasmin_ros::set_ros_loggers();

  auto sm = std::make_shared&lt;yasmin::StateMachine&gt;(
      std::initializer_list&lt;std::string&gt;{yasmin_ros::basic_outcomes::SUCCEED});

  rclcpp::on_shutdown([sm]() {
    if (sm-&gt;is_running()) {
      sm-&gt;cancel_state();
    }
  });

  sm-&gt;add_state("PUBLISHING_INT", std::make_shared&lt;PublishIntState&gt;(),
                {
                    {yasmin_ros::basic_outcomes::SUCCEED,
                     "CHECKINNG_COUNTS"},
                });
  sm-&gt;add_state("CHECKINNG_COUNTS",
                std::make_shared&lt;yasmin::CbState&gt;(
                    std::initializer_list&lt;std::string&gt;{"outcome1", "outcome2"},
                    check_count),
                {{"outcome1", yasmin_ros::basic_outcomes::SUCCEED},
                 {"outcome2", "PUBLISHING_INT"}});

  yasmin_viewer::YasminViewerPub yasmin_pub(sm, "YASMIN_PUBLISHER_DEMO");

  std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard =
      std::make_shared&lt;yasmin::blackboard::Blackboard&gt;();
  blackboard-&gt;set&lt;int&gt;("counter", 0);
  blackboard-&gt;set&lt;int&gt;("max_count", 10);

  try {
    std::string outcome = (*sm.get())(blackboard);
    YASMIN_LOG_INFO(outcome.c_str());
  } catch (const std::exception &e) {
    YASMIN_LOG_WARN(e.what());
  }

  rclcpp::shutdown();
  return 0;
}</code></pre>

            <h2>3. Run the Demo</h2>
            <p>Execute the publisher demo and use <code>ros2 topic echo /count</code> in another terminal to observe the incrementing integer messages being published by the state machine.</p>
            <pre><code class="language-bash">ros2 run yasmin_demos publisher_demo</code></pre>

    <div class="page-navigation">
        <a href="monitor_demo.html" class="nav-button prev">C++: Monitor Demo</a>
        <a href="parameters_demo.html" class="nav-button next">C++: ROS Parameters</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>