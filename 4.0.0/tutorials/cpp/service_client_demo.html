<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Client (C++) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="../python/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../python/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../python/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../python/service_client_demo.html">Service Client</a></li>
                <li><a href="../python/action_client_demo.html">Action Client</a></li>
                <li><a href="../python/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../python/publisher_demo.html">Publisher</a></li>
                <li><a href="../python/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../python/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../python/factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/src/service_client_demo.cpp" target="_blank" style="color: inherit; text-decoration: none;">Service Client (C++)</a></h1>
            <p>This tutorial demonstrates how to use the <code>ServiceState</code> in C++ to call ROS 2 services from a state machine. Services in ROS 2 are used for request-response communication - perfect for operations like calculations, queries, or triggering specific actions. We'll create a simple service client that adds two integers, showing how to prepare requests from blackboard data and process responses.</p>

            <h2>Prerequisites</h2>
            <p>You need a ROS 2 service server running. Start the example <code>AddTwoInts</code> service in a separate terminal:</p>
            <pre><code>ros2 run yasmin_demos add_two_ints_server</code></pre>

            <h2>1. Define Helper Functions</h2>
            <p>First, we define callback functions to set the input values and print the result. The <code>set_ints()</code> function stores two integers (a=10, b=5) in the blackboard - these will be used as inputs for the service call. The <code>print_sum()</code> function retrieves the sum from the blackboard after the service returns and logs it. Both functions return <code>SUCCEED</code> to indicate successful completion. These helper functions demonstrate the callback state pattern, which is useful for simple operations that don't require a full custom state class - perfect for data preparation, logging, or simple conditional checks.</p>

            <pre><code class="language-cpp">std::string
set_ints(std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard) {
  blackboard-&gt;set&lt;int&gt;("a", 10);
  blackboard-&gt;set&lt;int&gt;("b", 5);
  return yasmin_ros::basic_outcomes::SUCCEED;
}

std::string
print_sum(std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard) {
  std::stringstream ss;
  ss &lt;&lt; "Sum: " &lt;&lt; blackboard-&gt;get&lt;int&gt;("sum");
  YASMIN_LOG_INFO(ss.str().c_str());
  return yasmin_ros::basic_outcomes::SUCCEED;
}</code></pre>

            <h2>2. Define the Service State</h2>
            <p>Create a class inheriting from <code>yasmin_ros::ServiceState</code>, templated with the service type <code>AddTwoInts</code>. The constructor initializes the service state with four parameters: the service name (<code>"/add_two_ints"</code>), the request creation callback, a list of additional outcomes (beyond the default <code>SUCCEED</code> and <code>ABORT</code>), and the response handler. The <code>create_request_handler</code> method retrieves the integers <code>a</code> and <code>b</code> from the blackboard and populates a service request. The <code>response_handler</code> processes the service response by extracting the sum and storing it back in the blackboard, then returns <code>"outcome1"</code> to signal successful completion. This state automatically handles service client creation, waiting for the service to become available, and error handling.</p>

            <pre><code class="language-cpp">class AddTwoIntsState
    : public yasmin_ros::ServiceState&lt;example_interfaces::srv::AddTwoInts&gt; {
public:
  AddTwoIntsState()
      : yasmin_ros::ServiceState&lt;example_interfaces::srv::AddTwoInts&gt;(
            "/add_two_ints",
            std::bind(&amp;AddTwoIntsState::create_request_handler, this, _1),
            {"outcome1"},
            std::bind(&amp;AddTwoIntsState::response_handler, this, _1, _2)) {};

  example_interfaces::srv::AddTwoInts::Request::SharedPtr
  create_request_handler(
      std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard) {

    auto request =
        std::make_shared&lt;example_interfaces::srv::AddTwoInts::Request&gt;();
    request-&gt;a = blackboard-&gt;get&lt;int&gt;("a");
    request-&gt;b = blackboard-&gt;get&lt;int&gt;("b");
    return request;
  };

  std::string response_handler(
      std::shared_ptr&lt;yasmin::blackboard::Blackboard&gt; blackboard,
      example_interfaces::srv::AddTwoInts::Response::SharedPtr response) {

    blackboard-&gt;set&lt;int&gt;("sum", response-&gt;sum);
    return "outcome1";
  };
};</code></pre>

            <h2>3. Create the State Machine</h2>
            <p>In the main function, we build a sequential state machine with three states. The first state, <code>SETTING_INTS</code>, uses a callback state to initialize the input values in the blackboard. Upon success, it transitions to <code>ADD_TWO_INTS</code>, our service state that performs the addition by calling the ROS 2 service. If the service call succeeds (<code>outcome1</code>), we transition to <code>PRINTING_SUM</code> to display the result. If the service fails (<code>SUCCEED</code> or <code>ABORT</code> from the default outcomes), we exit with <code>outcome4</code>. The <code>YasminViewerPub</code> allows visualization of the state machine execution flow. This pattern - prepare inputs, call service, process outputs - is common in robotics applications for tasks like motion planning, object recognition, or sensor calibration.</p>
            <pre><code class="language-cpp">int main(int argc, char *argv[]) {
  YASMIN_LOG_INFO("yasmin_service_client_demo");
  rclcpp::init(argc, argv);
  yasmin_ros::set_ros_loggers();

  auto sm = std::make_shared&lt;yasmin::StateMachine&gt;(
      std::initializer_list&lt;std::string&gt;{"outcome4"});

  rclcpp::on_shutdown([sm]() {
    if (sm-&gt;is_running()) {
      sm-&gt;cancel_state();
    }
  });

  sm-&gt;add_state("SETTING_INTS",
                std::make_shared&lt;yasmin::CbState&gt;(
                    std::initializer_list&lt;std::string&gt;{
                        yasmin_ros::basic_outcomes::SUCCEED},
                    set_ints),
                {
                    {yasmin_ros::basic_outcomes::SUCCEED, "ADD_TWO_INTS"},
                });
  sm-&gt;add_state("ADD_TWO_INTS", std::make_shared&lt;AddTwoIntsState&gt;(),
                {
                    {"outcome1", "PRINTING_SUM"},
                    {yasmin_ros::basic_outcomes::SUCCEED, "outcome4"},
                    {yasmin_ros::basic_outcomes::ABORT, "outcome4"},
                });
  sm-&gt;add_state("PRINTING_SUM",
                std::make_shared&lt;yasmin::CbState&gt;(
                    std::initializer_list&lt;std::string&gt;{
                        yasmin_ros::basic_outcomes::SUCCEED},
                    print_sum),
                {
                    {yasmin_ros::basic_outcomes::SUCCEED, "outcome4"},
                });

  yasmin_viewer::YasminViewerPub yasmin_pub(sm, "YASMIN_SERVICE_CLIENT_DEMO");

  try {
    std::string outcome = (*sm.get())();
    YASMIN_LOG_INFO(outcome.c_str());
  } catch (const std::exception &amp;e) {
    YASMIN_LOG_WARN(e.what());
  }

  rclcpp::shutdown();
  return 0;
}</code></pre>

            <h2>4. Run the Demo</h2>
            <p>First, start the service server in one terminal to provide the AddTwoInts service that the state machine will call:</p>
            <pre><code class="language-bash">ros2 run yasmin_demos add_two_ints_server</code></pre>
            
            <p>Then run the service client demo in another terminal to execute the state machine that calls the service:</p>
            <pre><code class="language-bash">ros2 run yasmin_demos service_client_demo</code></pre>

    <div class="page-navigation">
        <a href="concurrence_demo.html" class="nav-button prev">C++: Concurrence</a>
        <a href="action_client_demo.html" class="nav-button next">C++: Action Client</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>