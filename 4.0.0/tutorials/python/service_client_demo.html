<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Client (Python) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                        <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="../cpp/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../cpp/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../cpp/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../cpp/service_client_demo.html">Service Client</a></li>
                <li><a href="../cpp/action_client_demo.html">Action Client</a></li>
                <li><a href="../cpp/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../cpp/publisher_demo.html">Publisher</a></li>
                <li><a href="../cpp/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../cpp/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../cpp/factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/yasmin_demos/service_client_demo.py" target="_blank" style="color: inherit; text-decoration: none;">Service Client Demo (Python)</a></h1>
            <p>This tutorial shows how to integrate ROS 2 services into a YASMIN state machine using the <code>ServiceState</code> class. Services in ROS 2 provide request-response communication - ideal for computations, queries, or triggering specific actions that complete quickly. Unlike actions, services don't provide feedback during execution and can't be canceled. We'll create a state that calls the <code>AddTwoInts</code> service to demonstrate the complete workflow: preparing a request from blackboard data, calling the service, and processing the response.</p>

            <h2>Prerequisites</h2>
            <p>You need a ROS 2 service server running. Start the example <code>AddTwoInts</code> service in a separate terminal:</p>
            <pre><code>ros2 run yasmin_demos add_two_ints_server</code></pre>

            <h2>1. Create the ServiceState</h2>
            <p>Create a custom state that inherits from <code>ServiceState</code> and implements request creation and response handling. The constructor takes five parameters: the service type (<code>AddTwoInts</code>), the service name (<code>"/add_two_ints"</code>), a callback to create the request, additional custom outcomes (beyond the default SUCCEED and ABORT), and a response handler. The <code>create_request_handler</code> method retrieves integers <code>a</code> and <code>b</code> from the blackboard and populates a service request object. The <code>response_handler</code> is called when the service returns, extracts the sum from the response, stores it in the blackboard, and returns <code>"outcome1"</code> to signal completion. The ServiceState automatically handles service availability checking and error scenarios.</p>

            <pre><code class="language-python">from yasmin_ros import ServiceState
from example_interfaces.srv import AddTwoInts

class AddTwoIntsState(ServiceState):
    """
    A state that calls the AddTwoInts service to add two integers.

    This class is a state in a finite state machine that sends a request
    to the AddTwoInts service, retrieves the response, and updates the
    blackboard with the result.

    Attributes:
        service_type (type): The service type being used (AddTwoInts).
        service_name (str): The name of the service.
        outcomes (list): The list of possible outcomes for this state.
    """

    def __init__(self) -> None:
        """
        Initializes the AddTwoIntsState.

        Calls the parent constructor with the specific service type,
        service name, request handler, outcomes, and response handler.
        """
        super().__init__(
            AddTwoInts,  # srv type
            "/add_two_ints",  # service name
            self.create_request_handler,  # cb to create the request
            ["outcome1"],  # outcomes. Includes (SUCCEED, ABORT)
            self.response_handler,  # cb to process the response
        )

    def create_request_handler(self, blackboard: Blackboard) -> AddTwoInts.Request:
        """
        Creates the service request from the blackboard data.

        Args:
            blackboard (Blackboard): The blackboard containing the input values.

        Returns:
            AddTwoInts.Request: The request object populated with values from the blackboard.
        """
        req = AddTwoInts.Request()
        req.a = blackboard["a"]
        req.b = blackboard["b"]
        return req

    def response_handler(
        self, blackboard: Blackboard, response: AddTwoInts.Response
    ) -> str:
        """
        Processes the response from the AddTwoInts service.

        Updates the blackboard with the sum result from the response.

        Args:
            blackboard (Blackboard): The blackboard to update with the sum.
            response (AddTwoInts.Response): The response from the service call.

        Returns:
            str: The outcome of the operation, which is "outcome1".
        """
        blackboard["sum"] = response.sum
        return "outcome1"</code></pre>

            <h2>2. Create Helper States</h2>
            <p>Create callback states to set input values and print the result. The <code>set_ints</code> function initializes the blackboard with two integers (a=10, b=5) that will be used as inputs for the service call. The <code>print_sum</code> function retrieves and logs the computed sum from the blackboard after the service completes. Both functions return <code>SUCCEED</code> to indicate successful execution. These simple callback functions demonstrate how to use <code>CbState</code> for straightforward operations that don't require a full custom state class - perfect for data preparation, logging, or simple conditional checks.</p>

            <pre><code class="language-python">from yasmin import CbState
from yasmin_ros.basic_outcomes import SUCCEED

def set_ints(blackboard: Blackboard) -> str:
    """
    Sets the integer values in the blackboard.

    This function initializes the blackboard with two integer values to be added.

    Args:
        blackboard (Blackboard): The blackboard to update with integer values.

    Returns:
        str: The outcome of the operation, which is SUCCEED.
    """
    blackboard["a"] = 10
    blackboard["b"] = 5
    return SUCCEED

def print_sum(blackboard: Blackboard) -> str:
    """
    Logs the sum value from the blackboard.

    This function retrieves the sum from the blackboard and logs it.

    Args:
        blackboard (Blackboard): The blackboard from which to retrieve the sum.

    Returns:
        str: The outcome of the operation, which is SUCCEED.
    """
    yasmin.YASMIN_LOG_INFO(f"Sum: {blackboard['sum']}")
    return SUCCEED</code></pre>

            <h2>3. Build the State Machine</h2>
            <p>Assemble the states into a state machine that orchestrates the complete service call workflow. The state machine initializes ROS 2, creates three states with defined transitions, and sets up the YASMIN viewer for real-time visualization. The <code>SETTING_INTS</code> state prepares the input data and transitions to <code>ADD_TWO_INTS</code> on success. The <code>ADD_TWO_INTS</code> service state can produce three outcomes: <code>"outcome1"</code> if the service returns successfully (transitioning to <code>PRINTING_SUM</code>), <code>SUCCEED</code> if completed without errors, or <code>ABORT</code> if the service fails (both terminating with <code>"outcome4"</code>). Finally, <code>PRINTING_SUM</code> logs the result and transitions to the final outcome. This sequential flow ensures proper data preparation, service execution, and result handling with graceful error management.</p>

            <pre><code class="language-python">def main() -> None:
    yasmin.YASMIN_LOG_INFO("yasmin_service_client_demo")

    # Init ROS 2
    rclpy.init()

    # Set ROS 2 logs
    set_ros_loggers()

    # Create a FSM
    sm = StateMachine(outcomes=["outcome4"])

    # Add states
    sm.add_state(
        "SETTING_INTS",
        CbState([SUCCEED], set_ints),
        transitions={SUCCEED: "ADD_TWO_INTS"},
    )
    sm.add_state(
        "ADD_TWO_INTS",
        AddTwoIntsState(),
        transitions={
            "outcome1": "PRINTING_SUM",
            SUCCEED: "outcome4",
            ABORT: "outcome4",
        },
    )
    sm.add_state(
        "PRINTING_SUM",
        CbState([SUCCEED], print_sum),
        transitions={
            SUCCEED: "outcome4",
        },
    )

    # Publish FSM info
    viewer = YasminViewerPub(sm, "YASMIN_SERVICE_CLIENT_DEMO")

    # Execute FSM
    try:
        outcome = sm()
        yasmin.YASMIN_LOG_INFO(outcome)
    except KeyboardInterrupt:
        if sm.is_running():
            sm.cancel_state()
    finally:
        viewer.cleanup()
        del sm

        # Shutdown ROS 2 if it's running
        if rclpy.ok():
            rclpy.shutdown()


if __name__ == "__main__":
    main()</code></pre>

            <h2>4. Run the Demo</h2>
            <p>First, start the service server that provides the integer addition functionality:</p>
            <pre><code>ros2 run yasmin_demos add_two_ints_server</code></pre>
            <p>Then run the client demo to execute the state machine that calls the service and displays the result:</p>
            <pre><code>ros2 run yasmin_demos service_client_demo.py</code></pre>

            <h2>Expected Output</h2>
            <p>The state machine will:</p>
            <ol>
                <li>Set <code>a = 10</code> and <code>b = 5</code></li>
                <li>Call the <code>/add_two_ints</code> service</li>
                <li>Print the sum: <code>Sum: 15</code></li>
            </ol>


    <div class="page-navigation">
        <a href="../python/concurrence_demo.html" class="nav-button prev">Python: Concurrence Demo</a>
        <a href="../python/action_client_demo.html" class="nav-button next">Python: Action Client Demo</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>
