<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Client (Python) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                        <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="../cpp/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../cpp/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../cpp/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../cpp/service_client_demo.html">Service Client</a></li>
                <li><a href="../cpp/action_client_demo.html">Action Client</a></li>
                <li><a href="../cpp/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../cpp/publisher_demo.html">Publisher</a></li>
                <li><a href="../cpp/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../cpp/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../cpp/factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/yasmin_demos/action_client_demo.py" target="_blank" style="color: inherit; text-decoration: none;">Action Client Demo (Python)</a></h1>
            <p>This tutorial demonstrates how to integrate ROS 2 actions into a YASMIN state machine using the <code>ActionState</code> class. Actions are perfect for long-running tasks that need to provide feedback during execution and can be canceled if needed - such as navigation, manipulation, or data processing tasks. We'll use the <code>Fibonacci</code> action as an example to show how to send goals, monitor feedback, and handle results. The ActionState automatically manages the action client lifecycle, handles timeouts, and provides clean integration with the state machine.</p>

            <h2>Prerequisites</h2>
            <p>Start the Fibonacci action server in a separate terminal before running this demo:</p>
            <pre><code>ros2 run yasmin_demos fibonacci_action_server</code></pre>

            <h2>1. Create the ActionState</h2>
            <p>Create a custom state that inherits from <code>ActionState</code>. The constructor takes six parameters: the action type (<code>Fibonacci</code>), the action name (<code>"/fibonacci"</code>), a callback to create the goal, optional custom outcomes (we use <code>None</code> to accept defaults: SUCCEED, ABORT, CANCEL), a response handler, and a feedback handler. The <code>create_goal_handler</code> retrieves the Fibonacci order from the blackboard and creates a goal request. The <code>response_handler</code> processes the final result and stores the sequence in the blackboard. The <code>print_feedback</code> method is called periodically during execution, allowing us to monitor the partial sequence as it's computed - this is one of the key advantages of actions over services.</p>

            <pre><code class="language-python">from yasmin_ros import ActionState
from example_interfaces.action import Fibonacci

class FibonacciState(ActionState):
    """
    Class representing the state of the Fibonacci action.

    Inherits from ActionState and implements methods to handle the
    Fibonacci action in a finite state machine.

    Attributes:
        None
    """

    def __init__(self) -> None:
        """
        Initializes the FibonacciState.

        Sets up the action type and the action name for the Fibonacci
        action. Initializes goal, response handler, and feedback
        processing callbacks.

        Args:
            None

        Returns:
            None
        """
        super().__init__(
            Fibonacci,  # action type
            "/fibonacci",  # action name
            self.create_goal_handler,  # callback to create the goal
            None,  # outcomes. Includes (SUCCEED, ABORT, CANCEL)
            self.response_handler,  # callback to process the response
            self.print_feedback,  # callback to process the feedback
        )

    def create_goal_handler(self, blackboard: Blackboard) -> Fibonacci.Goal:
        """
        Creates the goal for the Fibonacci action.

        This method retrieves the input value from the blackboard and
        populates the Fibonacci goal.

        Args:
            blackboard (Blackboard): The blackboard containing the state
            information.

        Returns:
            Fibonacci.Goal: The populated goal object for the Fibonacci action.

        Raises:
            KeyError: If the expected key is not present in the blackboard.
        """
        goal = Fibonacci.Goal()
        goal.order = blackboard["n"]  # Retrieve the input value 'n' from the blackboard
        return goal

    def response_handler(self, blackboard: Blackboard, response: Fibonacci.Result) -> str:
        """
        Handles the response from the Fibonacci action.

        This method processes the result of the Fibonacci action and
        stores it in the blackboard.

        Args:
            blackboard (Blackboard): The blackboard to store the result.
            response (Fibonacci.Result): The result object from the Fibonacci action.

        Returns:
            str: Outcome of the operation, typically SUCCEED.

        Raises:
            None
        """
        blackboard["fibo_res"] = (
            response.sequence
        )  # Store the result sequence in the blackboard
        return SUCCEED

    def print_feedback(
        self, blackboard: Blackboard, feedback: Fibonacci.Feedback
    ) -> None:
        """
        Prints feedback from the Fibonacci action.

        This method logs the partial sequence received during the action.

        Args:
            blackboard (Blackboard): The blackboard (not used in this method).
            feedback (Fibonacci.Feedback): The feedback object from the Fibonacci action.

        Returns:
            None

        Raises:
            None
        """
        yasmin.YASMIN_LOG_INFO(f"Received feedback: {list(feedback.sequence)}")</code></pre>

            <h2>2. Create Result Printing State</h2>
            <p>Define a callback state to print the Fibonacci sequence result stored in the blackboard after the action completes successfully.</p>
            <pre><code class="language-python">from yasmin import CbState
from yasmin_ros.basic_outcomes import SUCCEED

def print_result(blackboard: Blackboard) -> str:
    """
    Prints the result of the Fibonacci action.

    This function logs the final result stored in the blackboard.

    Args:
        blackboard (Blackboard): The blackboard containing the result.

    Returns:
        str: Outcome of the operation, typically SUCCEED.

    Raises:
        None
    """
    yasmin.YASMIN_LOG_INFO(f"Result: {blackboard['fibo_res']}")
    return SUCCEED</code></pre>

            <h2>3. Build the State Machine</h2>
            <p>Assemble the action client state and result printing state into a sequential state machine. Initialize the blackboard with the Fibonacci order value that will be sent as the action goal.</p>
            <pre><code class="language-python">rclpy.init()
set_ros_loggers()

sm = StateMachine(outcomes=["outcome4"])

sm.add_state(
    "CALLING_FIBONACCI",
    FibonacciState(),
    transitions={
        SUCCEED: "PRINTING_RESULT",
        CANCEL: "outcome4",
        ABORT: "outcome4",
    },
)
sm.add_state(
    "PRINTING_RESULT",
    CbState([SUCCEED], print_result),
    transitions={SUCCEED: "outcome4"},
)

YasminViewerPub(sm, "YASMIN_ACTION_CLIENT_DEMO")

blackboard = Blackboard()
blackboard["n"] = 10  # Fibonacci order</code></pre>

            <h2>4. Execute</h2>
            <p>Run the state machine with proper exception handling to gracefully handle interruptions and ensure clean shutdown of ROS resources.</p>
            <pre><code class="language-python">    # Publish FSM information
    viewer = YasminViewerPub(sm, "YASMIN_ACTION_CLIENT_DEMO")

    # Create an initial blackboard with the input value
    blackboard = Blackboard()
    blackboard["n"] = 10  # Set the Fibonacci order to 10

    # Execute the FSM
    try:
        outcome = sm(blackboard)
        yasmin.YASMIN_LOG_INFO(outcome)
    except KeyboardInterrupt:
        if sm.is_running():
            sm.cancel_state()  # Cancel the state if interrupted
    finally:
        viewer.cleanup()
        del sm

        # Shutdown ROS 2 if it's running
        if rclpy.ok():
            rclpy.shutdown()


if __name__ == "__main__":
    main()</code></pre>

            <h2>5. Run the Demo</h2>
            <p>Start the action server first to provide the Fibonacci computation service:</p>
            <pre><code>ros2 run yasmin_demos fibonacci_action_server</code></pre>
            <p>Then run the client to send the goal and receive feedback and results:</p>
            <pre><code>ros2 run yasmin_demos action_client_demo.py</code></pre>

            <h2>Expected Behavior</h2>
            <ul>
                <li>The action goal is sent with <code>order = 10</code></li>
                <li>Feedback is printed as the Fibonacci sequence is computed</li>
                <li>Final result displays the complete sequence: <code>[0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</code></li>
            </ul>


    <div class="page-navigation">
        <a href="../python/service_client_demo.html" class="nav-button prev">Python: Service Client Demo</a>
        <a href="../python/monitor_demo.html" class="nav-button next">Python: Monitor Demo</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>
