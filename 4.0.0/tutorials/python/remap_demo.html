<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackboard Remapping (Python) - YASMIN</title>
    <link rel="stylesheet" href="../../style.css">
    <script src="../../sidebar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="../../dark_mode.js"></script>
</head>
<body>
    <header>
        <a href="../../index.html" class="logo">
            <img src="../../logo.png" alt="YASMIN Logo">
            YASMIN
        </a>
        <div class="nav-links">
            <a href="../../index.html">Docs</a>
            <a href="https://github.com/uleroboticsgroup/yasmin" target="_blank">GitHub</a>
            <a href="../../doxygen.html" target="_blank">Doxygen</a>
            <button id="theme-toggle" title="Toggle Dark Mode">ðŸŒ™</button>
        </div>
    </header>

    <div class="container">
                        <nav class="sidebar">
            <h3>Getting Started</h3>
            <ul>
                <li><a href="../../index.html">Introduction</a></li>
                <li><a href="../../main_concepts.html">Main Concepts</a></li>
                <li><a href="../../packages.html">Packages Overview</a></li>
                <li><a href="../../docker.html">Docker</a></li>
                <li><a href="../../xml_factory.html">XML</a></li>
            </ul>
            
            <h3>Tutorials</h3>
            <ul>
                <li><a href="../../tutorials.html">All Tutorials</a></li>
            </ul>

            <h3 class="collapsible">C++ Tutorials</h3>
            <ul>
                <li><a href="../cpp/basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="../cpp/remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="../cpp/concurrence_demo.html">Concurrence</a></li>
                <li><a href="../cpp/service_client_demo.html">Service Client</a></li>
                <li><a href="../cpp/action_client_demo.html">Action Client</a></li>
                <li><a href="../cpp/monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="../cpp/publisher_demo.html">Publisher</a></li>
                <li><a href="../cpp/parameters_demo.html">ROS Parameters</a></li>
                <li><a href="../cpp/nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="../cpp/factory_demo.html">Factory (XML)</a></li>
            </ul>

            <h3 class="collapsible">Python Tutorials</h3>
            <ul>
                <li><a href="basic_fsm.html">Writing a Simple FSM</a></li>
                <li><a href="remap_demo.html">Blackboard Remapping</a></li>
                <li><a href="concurrence_demo.html">Concurrence</a></li>
                <li><a href="service_client_demo.html">Service Client</a></li>
                <li><a href="action_client_demo.html">Action Client</a></li>
                <li><a href="monitor_demo.html">Monitor (Subscriber)</a></li>
                <li><a href="publisher_demo.html">Publisher</a></li>
                <li><a href="parameters_demo.html">ROS Parameters</a></li>
                <li><a href="nav2_demo.html">Nav2 Demo</a></li>
                <li><a href="factory_demo.html">Factory (XML)</a></li>
            </ul>
            
            <h3>Tools</h3>
            <ul>
                <li><a href="../../yasmin_editor.html">YASMIN Editor</a></li>
                <li><a href="../../yasmin_factory.html">YASMIN Factory</a></li>
                <li><a href="../../yasmin_viewer.html">YASMIN Viewer</a></li>
            </ul>

            <h3>Resources</h3>
            <ul>
                <li><a href="../../citations.html">Citations</a></li>
            </ul>
        </nav>

        <main class="main-content content">
            <h1><a href="https://github.com/uleroboticsgroup/yasmin/blob/main/yasmin_demos/yasmin_demos/remap_demo.py" target="_blank" style="color: inherit; text-decoration: none;">Blackboard Remapping (Python)</a></h1>
            <p>This tutorial demonstrates how to use blackboard remapping in YASMIN to share data between states using different variable names. Remapping allows you to connect state outputs to different blackboard keys, enabling flexible data flow in your state machine. This is a powerful feature for creating reusable, modular states that can work with different data sources without code modification - essential for building maintainable and scalable robot behaviors.</p>

            <h2>Background</h2>
            <p>The <strong>Blackboard</strong> is a shared data structure that allows states to read and write data. Sometimes you want to:</p>
            <ul>
                <li>Reuse the same state class with different data keys (avoiding code duplication)</li>
                <li>Connect outputs from one state to inputs of another with different names (data pipelining)</li>
                <li>Maintain clear data flow without modifying state implementation (separation of concerns)</li>
                <li>Create generic states that work with any data by remapping at configuration time</li>
                <li>Build state libraries that can be composed flexibly in different state machines</li>
            </ul>
            <p>YASMIN provides <code>remappings</code> to achieve this without changing the state's code, making your state machines more modular and maintainable.</p>

            <h2>1. Create the Foo State</h2>
            <p>This state reads from <code>foo_data</code> and writes to <code>foo_out_data</code> in the blackboard. Notice how the state is designed generically - it doesn't know or care what the actual data represents. It simply performs a transformation: read input, process it (in this case just logging), and write output. This generic design is what makes remapping powerful: we can reuse this exact same state class multiple times with different actual data by remapping the keys. The state accesses the blackboard using Python's dictionary syntax (<code>blackboard["key"]</code>), making it intuitive and readable.</p>

            <pre><code class="language-python">class Foo(State):
    """
    Represents the Foo state in the state machine.
    """

    def __init__(self):
        """
        Initializes the FooState instance, setting up the outcomes.

        Outcomes:
            SUCCEED: Indicates the state should continue to the next state.
        """
        super().__init__(outcomes=[SUCCEED])

    def execute(self, blackboard: Blackboard):
        """
        Executes the logic for the Foo state.

        Args:
            blackboard (Blackboard): The shared data structure for states.

        Returns:
            str: The outcome of the execution, which can be SUCCEED.

        Raises:
            Exception: May raise exceptions related to state execution.
        """
        data = blackboard["foo_data"]
        yasmin.YASMIN_LOG_INFO(f"{data}")
        blackboard["foo_out_data"] = data
        return SUCCEED</code></pre>

            <h2>2. Create the Bar State</h2>
            <p>This state reads from <code>bar_data</code> and logs it. Like the Foo state, this is designed generically to work with remapping. It doesn't care where <code>bar_data</code> comes from or what it contains - it simply reads and processes it. This demonstrates a consumer state that can be connected to any producer state's output through remapping. The separation between the state's internal key names (<code>bar_data</code>) and the actual blackboard keys (which we'll set via remapping) is what enables flexible composition of state machines from reusable components.</p>

            <pre><code class="language-python">class BarState(State):
    """
    Represents the Bar state in the state machine.

    """

    def __init__(self):
        """
        Initializes the BarState instance, setting up the outcomes.

        Outcomes:
            SUCCEDED: Indicates the state should continue to the next state.
        """
        super().__init__(outcomes=[SUCCEED])

    def execute(self, blackboard: Blackboard):
        """
        Executes the logic for the Bar state.

        Args:
            blackboard (Blackboard): The shared data structure for states.

        Returns:
            str: The outcome of the execution, which can be SUCCEED.

        Raises:
            Exception: May raise exceptions related to state execution.
        """
        data = blackboard["bar_data"]
        yasmin.YASMIN_LOG_INFO(f"{data}")
        return SUCCEED</code></pre>

            <h2>3. Setup the State Machine with Remapping</h2>
            <p>Initialize the blackboard with different message keys and use remapping to connect them. We create a blackboard with two messages: <code>msg1="test1"</code> and <code>msg2="test2"</code>. Then we add three states using the <code>remappings</code> parameter in <code>add_state()</code>. In STATE1, we use the same Foo class but remap <code>foo_data</code> to <code>msg1</code>, so when the state reads <code>foo_data</code>, it actually gets <code>msg1</code>. In STATE2, we reuse Foo again but remap to <code>msg2</code>, processing different data with the same code. In STATE3, we use BarState and remap <code>bar_data</code> to <code>foo_out_data</code> (the output from STATE2), creating a data pipeline where the output of one state becomes the input of the next. This demonstrates the power of remapping: write states once, compose them flexibly. Try running this and you'll see "test1", "test2", and "test2" logged, showing how data flows through the remapped connections.</p>

            <pre><code class="language-python">rclpy.init()
set_ros_loggers()

bb = Blackboard()
bb["msg1"] = "test1"
bb["msg2"] = "test2"

sm = StateMachine(outcomes=[SUCCEED])

# STATE1: remap foo_data to msg1
sm.add_state(
    "STATE1",
    Foo(),
    transitions={SUCCEED: "STATE2"},
    remappings={"foo_data": "msg1"},
)

# STATE2: remap foo_data to msg2
sm.add_state(
    "STATE2",
    Foo(),
    transitions={SUCCEED: "STATE3"},
    remappings={"foo_data": "msg2"},
)

# STATE3: remap bar_data to foo_out_data (output from STATE2)
sm.add_state(
    "STATE3",
    BarState(),
    transitions={SUCCEED: SUCCEED},
    remappings={"bar_data": "foo_out_data"},
)</code></pre>

            <h2>4. Execute the State Machine</h2>
            <p>Execute the state machine with the initialized blackboard. Observe how remapping allows the same state class to work with different data without code modification.</p>
            <pre><code class="language-python">    # Launch YASMIN Viewer publisher for state visualization
    viewer = YasminViewerPub(sm, "YASMIN_REMAPPING_DEMO")

    # Execute the FSM
    try:
        outcome = sm(bb)
        yasmin.YASMIN_LOG_INFO(outcome)
    except KeyboardInterrupt:
        if sm.is_running():
            sm.cancel_state()
    finally:
        viewer.cleanup()
        del sm

        # Shutdown ROS 2 if it's running
        if rclpy.ok():
            rclpy.shutdown()


if __name__ == "__main__":
    main()</code></pre>

            <h2>5. Run the Demo</h2>
            <p>Run the remapping demonstration to see how blackboard key remapping enables state reuse with different data sources.</p>
            <pre><code>ros2 run yasmin_demos remap_demo.py</code></pre>

            <h2>Expected Output</h2>
            <p>The state machine will:</p>
            <ol>
                <li><strong>STATE1:</strong> Read <code>msg1</code> (remapped as <code>foo_data</code>) â†’ prints "test1"</li>
                <li><strong>STATE2:</strong> Read <code>msg2</code> (remapped as <code>foo_data</code>) â†’ prints "test2"</li>
                <li><strong>STATE3:</strong> Read <code>foo_out_data</code> (remapped as <code>bar_data</code>) â†’ prints "test2"</li>
            </ol>


    <div class="page-navigation">
        <a href="../python/basic_fsm.html" class="nav-button prev">Python: Writing a Simple FSM</a>
        <a href="../python/concurrence_demo.html" class="nav-button next">Python: Concurrence Demo</a>
    </div>
        </main>
    </div>

    <footer>
        <p>&copy; 2025 YASMIN Project. Licensed under GPL v3.0. | Documentation generated with <a href="../../doxygen.html" target="_blank">Doxygen</a></p>
    </footer>
</body>
</html>
